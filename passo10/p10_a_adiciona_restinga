var limite_MA = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-48.593359954293625, -30.678347823900353],
          [-47.275000579293625, -25.525376684152373],
          [-40.595313079293625, -23.284530667538736],
          [-33.915625579293625, -6.580343714417967],
          [-35.453711516793625, -4.217995607905081],
          [-44.198828704293625, -17.856203449528717],
          [-50.483008391793625, -17.52126295946964],
          [-55.712500579293625, -21.74193426005608],
          [-55.492774016793625, -29.72888025446976]]]);

var remove_agricultura = 
    /* color: #d63000 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-46.87340391224189, -23.339541924072712],
                  [-46.878818122252135, -23.346694266303192],
                  [-46.884311286314635, -23.356465502277203],
                  [-46.8822513497912, -23.366551184662377],
                  [-46.89996821692527, -23.37194871154414],
                  [-46.92808946099619, -23.379938307139835],
                  [-46.93238099693187, -23.394591216360165],
                  [-46.89461549400218, -23.433027702502102],
                  [-46.920708023299056, -23.44531241998235],
                  [-46.90869172691234, -23.471138100002133],
                  [-46.94479134915195, -23.525024345096092],
                  [-46.96195748684726, -23.5637375429487],
                  [-46.9585242593082, -23.572863383949723],
                  [-46.94925454495273, -23.57003129425457],
                  [-46.931401761749605, -23.55366691369021],
                  [-46.898684364200754, -23.59705605947918],
                  [-46.89250455463044, -23.61278587789286],
                  [-46.87098935134185, -23.634880237296098],
                  [-46.853885398925804, -23.669587261036494],
                  [-46.850108848632836, -23.729945983304773],
                  [-46.80376027685549, -23.76481255858118],
                  [-46.79037068945315, -23.774238562116768],
                  [-46.77080129248049, -23.78366388258684],
                  [-46.72994588476565, -23.805339526316494],
                  [-46.67638753515627, -23.7943450864431],
                  [-46.61252950292971, -23.796858183303552],
                  [-46.48241017919924, -23.758842403138676],
                  [-46.441898094238304, -23.75098651823591],
                  [-46.377696739257836, -23.712643001567233],
                  [-46.38181661230471, -23.669886120839145],
                  [-46.386966453613304, -23.636551202056623],
                  [-46.406192527832054, -23.628373415556247],
                  [-46.38765309912112, -23.608555892259346],
                  [-46.370486961425804, -23.603836992623506],
                  [-46.35503743750002, -23.59911792315348],
                  [-46.344737754882836, -23.602578590703096],
                  [-46.329288230957054, -23.58558898298015],
                  [-46.325511680664086, -23.590937800496796],
                  [-46.314525352539086, -23.61264546788007],
                  [-46.28499959570315, -23.590937800496796],
                  [-46.27059228138039, -23.58685159023491],
                  [-46.25647313312599, -23.587205559431034],
                  [-46.25630147174904, -23.585278382255982],
                  [-46.25522858814308, -23.582407229079802],
                  [-46.25552899555275, -23.56879789541862],
                  [-46.25986344532082, -23.568247199047203],
                  [-46.2678027840049, -23.566870448016974],
                  [-46.26857526020119, -23.56592638182744],
                  [-46.268704006233904, -23.564824962697468],
                  [-46.26754529193947, -23.561048598429995],
                  [-46.26561410144875, -23.559160375591624],
                  [-46.240135490828564, -23.542646546931024],
                  [-46.22125273936372, -23.52879701117885],
                  [-46.23841887705903, -23.510853399763192],
                  [-46.229149162703564, -23.49920448358523],
                  [-46.19378691905122, -23.484405726770323],
                  [-46.21404296153169, -23.464251557539296],
                  [-46.21026641123872, -23.45858264281891],
                  [-46.22228270762544, -23.442834380472608],
                  [-46.22296935313325, -23.430234418966084],
                  [-46.23258239024263, -23.421413731339197],
                  [-46.2586749195395, -23.42078365971037],
                  [-46.280304253035595, -23.392427330953023],
                  [-46.29609709971528, -23.38675533636946],
                  [-46.32905608409028, -23.370683366450773],
                  [-46.40630370371919, -23.332228789928127],
                  [-46.45745879405122, -23.35996763731585],
                  [-46.473594963484814, -23.359652455705625],
                  [-46.525882203225805, -23.335253629731923],
                  [-46.58493371689768, -23.310662640085493],
                  [-46.64878661317564, -23.32186069834349],
                  [-46.674197632913305, -23.341243053237477],
                  [-46.719858790093426, -23.343770018751435],
                  [-46.753848511819555, -23.332416440106414],
                  [-46.87332483017893, -23.33304693192721]]]),
            {
              "reference": 200,
              "system:index": "0"
            })]),
    converter12para21 = 
    /* color: #d63000 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-42.202620147226526, -16.51959809656551],
                  [-41.691755889414026, -16.32332469095473],
                  [-41.6079851374609, -15.964520098104499],
                  [-42.03002431935306, -15.818078733995005],
                  [-42.16760122632809, -15.827159222812838],
                  [-42.290510772226526, -16.159832701694288],
                  [-42.2451921687109, -16.4866801681935]]]),
            {
              "reference": 100,
              "system:index": "0"
            })]),
    converter21para4 = 
    /* color: #98ff00 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-42.3275896296484, -17.137842854655215],
                  [-42.35780203199215, -17.210006141859733],
                  [-42.411360381601526, -17.32278683965696],
                  [-42.356428740976526, -17.504925441949702],
                  [-42.265791533945276, -17.50361574181354],
                  [-42.205366729257776, -17.45777029328978],
                  [-42.194380401132776, -17.42763699951511],
                  [-42.1682878718359, -17.415844355805373],
                  [-42.09413015699215, -17.37084567621821],
                  [-42.07765066480465, -17.3341435649109],
                  [-42.08863699292965, -17.226616639818317],
                  [-42.142195342539026, -17.180701917402498],
                  [-42.205366729257776, -17.145274212418173],
                  [-42.28639089917965, -17.115089724344678]]]),
            {
              "reference": 200,
              "system:index": "0"
            })]),
    converter9para3 = 
    /* color: #98ff00 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-37.65653884770504, -11.986750549904498],
                  [-37.65529809511411, -11.991403072904413],
                  [-37.650019507772804, -11.99681829397333],
                  [-37.644483428366065, -11.99824554343396],
                  [-37.640234809286476, -11.990983283784608],
                  [-37.64731584108579, -11.988290978576398],
                  [-37.6355570367645, -11.984302909569996],
                  [-37.6320808938812, -11.978761494820295],
                  [-37.65109239137876, -11.97506715514358],
                  [-37.65732439162662, -11.976791412346092],
                  [-37.65955598952701, -11.984893653089324],
                  [-37.65702398421695, -11.985229492016664]]]),
            {
              "reference": 300,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-37.663470823217644, -11.993837840084156],
                  [-37.65965135758044, -11.992914311494532],
                  [-37.65879305069567, -11.989178186294005],
                  [-37.662698347021355, -11.989136207065215],
                  [-37.66304166977526, -11.99102526589404],
                  [-37.663470823217644, -11.991822864539007],
                  [-37.66531618301989, -11.991780885721754]]]),
            {
              "reference": 300,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-37.7255073059615, -12.024574662699875],
                  [-37.70121722112263, -12.034732108718913],
                  [-37.69374995122517, -12.02331544844786],
                  [-37.71649508367146, -12.010555078311246]]]),
            {
              "reference": 300,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-37.75573307724281, -12.03902172707378],
                  [-37.757106368258434, -12.050941355623577],
                  [-37.72981220932289, -12.05849577572635],
                  [-37.718396727755504, -12.051277112144552],
                  [-37.74388844223304, -12.036335540560293]]]),
            {
              "reference": 300,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-37.92406973982842, -12.024910392783227],
                  [-37.91724620009453, -12.031961874839574],
                  [-37.91355548049004, -12.034102466727699],
                  [-37.91321215773613, -12.038509513988624],
                  [-37.91329798842461, -12.043084372291453],
                  [-37.9135125651458, -12.047281421457669],
                  [-37.909878123142384, -12.047643958347672],
                  [-37.90730320248809, -12.046846525131215],
                  [-37.90266834531035, -12.048819118770169],
                  [-37.892883605359934, -12.0469136045017],
                  [-37.87999600701775, -12.029912490245302],
                  [-37.867584798335606, -12.027929707720636],
                  [-37.84346637487369, -12.021046017037918],
                  [-37.84080562353092, -12.008789253853172],
                  [-37.88863188558589, -11.999513226849869],
                  [-37.899189060268505, -12.004886308243341],
                  [-37.904682224331005, -12.002031872091],
                  [-37.91232115560542, -12.001528144925615],
                  [-37.91609770589839, -11.996910602044995],
                  [-37.9222775154687, -11.99674268990452],
                  [-37.923135822353466, -12.010091378668756],
                  [-37.90639884400295, -12.014582699275241],
                  [-37.90729994499889, -12.027573854982295],
                  [-37.91324385106028, -12.025338836112232],
                  [-37.91535744931861, -12.02422126280804],
                  [-37.9164142351935, -12.019800839075362],
                  [-37.922620838222606, -12.022432030669949]]]),
            {
              "reference": 300,
              "system:index": "4"
            })]);


var vesion_in = '15'
var versao_out = '16';
var descricao = 'Adiciona restinga e faz correcoes pontuais'
var col = 8.0
var prefixo_in = 'MA_col8_p09e_v'
var prefixo_out = 'MA_col8_p10a_v'
var dirout = 'projects/mapbiomas-workspace/COLECAO8/pos_classificacao-ma/';


////*************************************************************
// Do not Change from these lines
////*************************************************************
var biomes = ee.Image('projects/mapbiomas-workspace/AUXILIAR/biomas-raster-41');
var bioma250mil_MA = biomes.mask(biomes.eq(2));
Map.addLayer(bioma250mil_MA,{'palette': 'ccffcc'}, 'bioma250mil_MA', false)


var palettes = require('users/mapbiomas/modules:Palettes.js');

var class7 = ee.Image(dirout+prefixo_in+vesion_in)

var palettes = require('users/mapbiomas/modules:Palettes.js');
var pal = palettes.get('classification2');
var vis = {
      bands: 'classification_2020',
    'min': 0,
    'max': 45,
    'palette': palettes.get('classification5')
    };
var vis2 = {
    'min': 0,
    'max': 45,
    'palette': palettes.get('classification5')
};

Map.addLayer(class7, vis, 'class7');


var terrain = ee.Image("JAXA/ALOS/AW3D30_V1_1").select("AVE");

var slope = ee.Terrain.slope(terrain)

var plan = terrain.lt(25).clip(restinga).selfMask()

var solo_costeiro = ee.FeatureCollection('projects/mapbiomas-workspace/AUXILIAR/RESTINGA/SolosIBGE_SCostMarinhoBR')
solo_costeiro = solo_costeiro.map(function altera(feat) {return feat.set('reference',1)})
Map.addLayer(solo_costeiro)

var vetor_correcoes = solo_costeiro.merge(remove_agricultura).merge(converter12para21).merge(converter9para3)

  var imagem_correcoes = vetor_correcoes.reduceToImage({properties: ['reference'],reducer: ee.Reducer.first()})

var anos = ['1985','1986','1987','1988','1989','1990','1991','1992','1993','1994','1995',
            '1996','1997','1998','1999','2000','2001','2002','2003','2004','2005','2006',
            '2007','2008','2009','2010','2011','2012','2013','2014','2015','2016','2017',
            '2018','2019','2020','2021','2022'];
for (var i_ano=0;i_ano<anos.length; i_ano++){  
  var ano = anos[i_ano]; 
  
  
  var col7_ano = class7.select('classification_'+ano).remap(
     [3,4,9,11,12,13,19,21,22,29,33],
     [3,4,9,11,12,13,41,21,25,29,33]).rename('classification_'+ano)
  var restinga_abor = col7_ano.mask(col7_ano.eq(3).and(plan.eq(1))).remap([3],[49]).rename('classification_'+ano)
  var restinga_herb = col7_ano.mask(col7_ano.eq(13).and(imagem_correcoes.eq(1))).remap([13],[50]).rename('classification_'+ano)
  var corrige_campo = col7_ano.add(imagem_correcoes)
  .remap([3,4,9,11,12,13,41,21,25,29,33,103,104,109,111,112,113,141,121,125,129,133],
         [3,4,9,11,12,13,41,21,25,29,33,3,4,9,11,21,13,41,21,25,29,33])
         .clip(converter12para21).rename('classification_'+ano)
  var corrige_agric = col7_ano.add(imagem_correcoes)
  .remap([3,4,9,11,12,13,41,21,25,29,33,203,204,209,211,212,213,241,221,225,229,233],
         [3,4,9,11,12,13,41,21,25,29,33,3,4,9,11,12,13,21,21,25,29,33])
         .clip(remove_agricultura).rename('classification_'+ano)
  var corrige_reflo = col7_ano.add(imagem_correcoes)
  .remap([3,4,9,11,12,13,41,21,25,29,33,303,304,309,311,312,313,341,321,325,329,333],
         [3,4,9,11,12,13,41,21,25,29,33,3,4,3,11,12,13,41,21,25,29,33]).rename('classification_'+ano)
           .clip(converter9para3).rename('classification_'+ano)

  
  var class_out = col7_ano.blend(corrige_campo).blend(corrige_agric).blend(corrige_reflo)
  .blend(restinga_abor).blend(restinga_herb)

  if (i_ano == 0){ var class_outTotal = class_out }  
  else {class_outTotal = class_outTotal.addBands(class_out); }
}
Map.addLayer(class_outTotal, vis, 'class7 com restinga');

class_outTotal = class_outTotal
.set('territory', 'MATAATLANTICA')
.set('biome', 'MATAATLANTICA')
.set('source', 'arcplan')
.set('version', versao_out)
.set('year', versao_out)
.set('collection_id', col)
.set('description', descricao)

Export.image.toAsset({
    'image': class_outTotal,
    'description': prefixo_out+versao_out,
    'assetId': dirout+prefixo_out+versao_out,
    'pyramidingPolicy': {
        '.default': 'mode'
    },
    'region': limite_MA,
    'scale': 30,
    'maxPixels': 1e13
});
