var limite_MA = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-48.593359954293625, -30.678347823900353],
          [-47.275000579293625, -25.525376684152373],
          [-40.595313079293625, -23.284530667538736],
          [-33.915625579293625, -6.580343714417967],
          [-35.453711516793625, -4.217995607905081],
          [-44.198828704293625, -17.856203449528717],
          [-50.483008391793625, -17.52126295946964],
          [-55.712500579293625, -21.74193426005608],
          [-55.492774016793625, -29.72888025446976]]]);

var remove_reflo_3 = /* color: #d63000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-42.60569322068577, -19.795321920031405],
                  [-42.58123147446995, -19.809211830523843],
                  [-42.576939940046124, -19.815268097867555],
                  [-42.56406533677464, -19.817286802395],
                  [-42.5495599504221, -19.809292582272036],
                  [-42.546985029767804, -19.806870011994107],
                  [-42.5440667863596, -19.806950764931074],
                  [-42.538487791608624, -19.81244186847399],
                  [-42.531192183088116, -19.8154295951729],
                  [-42.52029168565159, -19.81244186847399],
                  [-42.49994981248265, -19.809373333979238],
                  [-42.49960648972874, -19.80622398702254],
                  [-42.49969232041722, -19.796775572113393],
                  [-42.49340085060347, -19.792093496856324],
                  [-42.48619107277144, -19.79063980202158],
                  [-42.47451809913863, -19.774486744387342],
                  [-42.48052624733199, -19.762693978318843],
                  [-42.48304720109081, -19.76019884208843],
                  [-42.479270650797844, -19.757048522745254],
                  [-42.477468206339836, -19.746143090800164],
                  [-42.483991338664055, -19.72707699044975],
                  [-42.494489974866006, -19.725571321548518],
                  [-42.49783737171659, -19.720319615896763],
                  [-42.50032646168241, -19.7039170243865],
                  [-42.498562887928564, -19.696151190250113],
                  [-42.502253607533056, -19.682897964304882],
                  [-42.49459875507587, -19.661567061450747],
                  [-42.48344076557392, -19.65025095861971],
                  [-42.482864451809284, -19.641093807018738],
                  [-42.49213416616475, -19.642387190107325],
                  [-42.494365764065144, -19.623793806722084],
                  [-42.49264915029561, -19.604389721404015],
                  [-42.48937526882035, -19.591810617516582],
                  [-42.49143520534379, -19.577093142075057],
                  [-42.509802972677775, -19.571432216527143],
                  [-42.521819269064494, -19.575960972876114],
                  [-42.524050866964885, -19.55784518397982],
                  [-42.51907240037934, -19.552081501491227],
                  [-42.51048933153169, -19.551919738427557],
                  [-42.49915968065278, -19.521343608471827],
                  [-42.50585447435395, -19.513488949778647],
                  [-42.52199064378755, -19.50507504552328],
                  [-42.51220594530122, -19.489055056522286],
                  [-42.5690258610727, -19.504427803987845],
                  [-42.588902686506046, -19.546570317966214],
                  [-42.57928964939667, -19.582964125474465],
                  [-42.58453267361238, -19.62412191194613],
                  [-42.61806660510334, -19.66236198483173],
                  [-42.627336319458806, -19.68515331160629],
                  [-42.6299112401131, -19.71742202413703],
                  [-42.643815811646306, -19.73067239009598],
                  [-42.64467411853107, -19.759916258204644],
                  [-42.638587028199126, -19.764787230652875],
                  [-42.63991740387051, -19.77250098942867],
                  [-42.643865615540435, -19.786029455275997],
                  [-42.63772872131436, -19.790390626232675],
                  [-42.62253402074905, -19.796357859926758]]]),
            {
              "reference": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-44.118813867608964, -20.022644844450625],
                  [-44.11883532528108, -20.023209343429798],
                  [-44.11870657924837, -20.023854482638473],
                  [-44.11859929088777, -20.02595116678304],
                  [-44.11857162069116, -20.026555974320274],
                  [-44.11803517888818, -20.026717255937196],
                  [-44.11827121328149, -20.02691885772563],
                  [-44.118614536035395, -20.02730190041133],
                  [-44.11818538259301, -20.027644622023114],
                  [-44.11629710744653, -20.027926862789368],
                  [-44.11445174764428, -20.027906702751437],
                  [-44.11393676351342, -20.02776558241356],
                  [-44.11348615239892, -20.027483341357712],
                  [-44.11348615239892, -20.02788654271092],
                  [-44.1130140836123, -20.02853166272473],
                  [-44.112649303186274, -20.028451022867817],
                  [-44.11206994603906, -20.027362380750056],
                  [-44.111383300531244, -20.026898697558416],
                  [-44.11076102803979, -20.026374532303436],
                  [-44.11016021322045, -20.026213250334884],
                  [-44.10975251745019, -20.02581004468954],
                  [-44.108894210565424, -20.02597132707178],
                  [-44.107628207910395, -20.02740270096295],
                  [-44.10681281636987, -20.027725262293757],
                  [-44.105353694665766, -20.02867278237479],
                  [-44.10423789571557, -20.02885422173869],
                  [-44.10224233220849, -20.028652622432542],
                  [-44.10121236394677, -20.02853166272473],
                  [-44.100375514734125, -20.02891470148012],
                  [-44.09925971578393, -20.02893486138874],
                  [-44.097886424768305, -20.028592142590277],
                  [-44.09627709935937, -20.027805902523024],
                  [-44.09730706762109, -20.0274430211655],
                  [-44.097886424768305, -20.027926862789368],
                  [-44.098916393030024, -20.028309903018638],
                  [-44.100118022668696, -20.02804782296261],
                  [-44.10153422902856, -20.027604301872277],
                  [-44.10254273961816, -20.02788654271092],
                  [-44.103379588830805, -20.027705102229973],
                  [-44.10451684545312, -20.026898697558416],
                  [-44.10728488515649, -20.02508427192174],
                  [-44.10719905446801, -20.024580261083816],
                  [-44.1070703084353, -20.023128700842584],
                  [-44.10674844335351, -20.0228262907721],
                  [-44.1055038983706, -20.022564201573847],
                  [-44.105396610010004, -20.021798092181662],
                  [-44.106405120599604, -20.021939217876493],
                  [-44.106877189386225, -20.022140825792235],
                  [-44.107606750238276, -20.022201308116554],
                  [-44.10825048040185, -20.021898896262318],
                  [-44.10874400686059, -20.022241629653173],
                  [-44.109645229089594, -20.02252388011995],
                  [-44.11018167089257, -20.022382754949913],
                  [-44.110889774072504, -20.02187873545136],
                  [-44.110095840204096, -20.019795903218455],
                  [-44.1070703084353, -20.015118463259277],
                  [-44.10756383489404, -20.01457409698591],
                  [-44.10758529256616, -20.013807948668834],
                  [-44.108593803155756, -20.0140498906458],
                  [-44.11024604390893, -20.01501765483226],
                  [-44.11022458623681, -20.01544104979151],
                  [-44.109859805810785, -20.015662827648633],
                  [-44.11005292485986, -20.01588460519303],
                  [-44.110589366662836, -20.015824120439213],
                  [-44.11091281277789, -20.014887771366467],
                  [-44.11166383130206, -20.014343404294706],
                  [-44.11166383130206, -20.012165917168755],
                  [-44.11359502179278, -20.01063359334564],
                  [-44.116255773135556, -20.010089211552405],
                  [-44.11694241864337, -20.00958515265696],
                  [-44.117071164676084, -20.009806938769913],
                  [-44.1167492995943, -20.010452132957194],
                  [-44.116792214938535, -20.011399757122824],
                  [-44.117307199069394, -20.01194413438129],
                  [-44.11722136838092, -20.012165917168755],
                  [-44.11589099270953, -20.01158121641828],
                  [-44.114539159366025, -20.01234737558048],
                  [-44.11340190274371, -20.013698226066417],
                  [-44.11331060347179, -20.014505481433915],
                  [-44.115413455339464, -20.0170055194966],
                  [-44.11620738920787, -20.018013588117977],
                  [-44.11633613524059, -20.019102294971294],
                  [-44.11599281248668, -20.019666806668656],
                  [-44.11610439542819, -20.020455076348217],
                  [-44.11782100919772, -20.02247116290272]]]),
            {
              "reference": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-40.15714777497752, -19.051811465116693],
                  [-40.13792170075877, -19.061546684419163],
                  [-40.12762201814158, -19.072579242048995],
                  [-40.02702845124705, -19.037207565111398],
                  [-40.007115731520486, -19.046294587249566],
                  [-39.99921930818064, -19.041102064078068],
                  [-39.98376978425486, -19.05083791176259],
                  [-39.961453805250954, -19.04986435269603],
                  [-39.974156747145486, -19.057652665266282],
                  [-39.95527399568064, -19.072579242048995],
                  [-39.95617255813772, -19.0953348584102],
                  [-39.99164178768693, -19.10606358899251],
                  [-39.98454039039063, -19.111600623823307],
                  [-39.936897934881564, -19.154514323354977],
                  [-39.9762053780804, -19.156008788411246],
                  [-39.991485818437276, -19.159459843958903],
                  [-40.00494827983146, -19.11119918753548],
                  [-40.0315897353712, -19.09030900044353],
                  [-40.04971728429052, -19.09803104330204],
                  [-40.05122836097044, -19.11616632258296],
                  [-40.026645736238265, -19.114836865555407],
                  [-40.01923158342442, -19.13508515026725],
                  [-40.057821481362744, -19.13846267086294],
                  [-40.078562841437524, -19.15870104418726],
                  [-40.04039232664143, -19.16221892249613],
                  [-40.03699584755371, -19.20335254669544],
                  [-40.00750341716208, -19.19649675360802],
                  [-40.00482651082051, -19.165919928287668],
                  [-39.98711186323546, -19.172211426440292],
                  [-39.99784578056082, -19.245922069224385],
                  [-39.953877385029195, -19.241769997567424],
                  [-39.9113058821566, -19.177443062920794],
                  [-39.907187550452136, -19.15357126116068],
                  [-39.892770204368794, -19.15007017487612],
                  [-39.88487682449768, -19.100961177804574],
                  [-39.88659804812789, -19.0661263268374],
                  [-39.88935602693064, -19.05732815954309],
                  [-39.89862574128611, -19.030391972133785],
                  [-39.9365636973912, -19.02081825502744],
                  [-39.95733393220408, -19.03461118171954],
                  [-39.9858297207783, -19.001503736904663],
                  [-40.01775873689158, -18.995660562379182],
                  [-40.06239069489939, -18.983648948344833],
                  [-40.07887018708689, -18.986570772051625],
                  [-40.14793523919345, -18.958040247412654],
                  [-40.176087705013764, -18.948623687137253],
                  [-40.21591314446689, -18.90965296412909],
                  [-40.257491122312, -19.022710907554718]]]),
            {
              "reference": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-39.38878605229468, -17.896204343476594],
                  [-39.35445377690405, -17.89032344800844],
                  [-39.289222453661864, -17.876600600897056],
                  [-39.267249797411864, -17.848498130551004],
                  [-39.204078410693114, -17.75958670525125],
                  [-39.26862308842749, -17.749777587433883],
                  [-39.26518986088843, -17.72688755571117],
                  [-39.2418439136228, -17.715768485234328],
                  [-39.2418439136228, -17.699415658842458],
                  [-39.22673771245093, -17.668014057553872],
                  [-39.31256840092749, -17.666705538457368],
                  [-39.308448527880614, -17.7164225672894],
                  [-39.349647258349364, -17.714460313968424],
                  [-39.39221927983374, -17.78835701381982],
                  [-39.37642643315405, -17.790972266713773],
                  [-39.36406681401343, -17.762202379178067],
                  [-39.34827396733374, -17.783780229098582],
                  [-39.3736798511228, -17.821698617618463],
                  [-39.374366496630614, -17.875293607772534],
                  [-39.43616459233374, -17.875947105536795],
                  [-39.43616459233374, -17.909272302152644]]]),
            {
              "reference": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-39.33158045042805, -17.176268834286123],
                  [-39.30102472533039, -17.1661002200325],
                  [-39.24300317992024, -17.148057758408076],
                  [-39.24849634398274, -17.133294440193794],
                  [-39.27905206908039, -17.126076391063226],
                  [-39.236823370349924, -17.10770191092815],
                  [-39.20710135510123, -17.014911040093896],
                  [-39.218685026994116, -16.984756237185568],
                  [-39.2341345509199, -16.987711344797578],
                  [-39.28048312269724, -17.008724100155224],
                  [-39.32923495375193, -17.026780053715243],
                  [-39.35738741957224, -16.97753244482874],
                  [-39.39206301771677, -16.991979751368234],
                  [-39.37283694349802, -17.02087102427592],
                  [-39.380733366837866, -17.046803709739493],
                  [-39.39412295424021, -17.055337730808777],
                  [-39.400989409318335, -17.073382511147653],
                  [-39.35841738783396, -17.084540717347018],
                  [-39.355327483048804, -17.097339013832567],
                  [-39.404765959611304, -17.11833944088129],
                  [-39.415752287736304, -17.130807323062236],
                  [-39.397212859025366, -17.161405574663952],
                  [-39.35464083754099, -17.181742760339503]]]),
            {
              "reference": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-39.40990086902222, -16.915968740462013],
                  [-39.29454442370972, -16.889032436237635],
                  [-39.23686620105347, -16.917939538426978],
                  [-39.15927525867066, -16.927793218925178],
                  [-39.15858861316285, -16.908742304884708],
                  [-39.19704076160035, -16.883119074082952],
                  [-39.38518163074097, -16.85420663816172],
                  [-39.3920480858191, -16.845006299358747],
                  [-39.42844029773316, -16.86143516183781],
                  [-39.4195139061316, -16.898230631273496]]]),
            {
              "reference": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-39.24022601364565, -16.541542682554763],
                  [-39.1990272831769, -16.54615022136786],
                  [-39.153022034153466, -16.53166901456026],
                  [-39.15164874313784, -16.51981994631238],
                  [-39.169501526340966, -16.485585223571686],
                  [-39.1550819706769, -16.456612651706042],
                  [-39.21482012985659, -16.475050244109035],
                  [-39.32742999313784, -16.426318517038492],
                  [-39.35764239548159, -16.489535693103242],
                  [-39.251898987278466, -16.58169039026564]]]),
            {
              "reference": 3,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-47.57875786033659, -23.439813866454394],
                  [-47.59523735252409, -23.425323476006735],
                  [-47.61309013572721, -23.44044384739717],
                  [-47.61171684471159, -23.422488213854898],
                  [-47.62270317283659, -23.414927217648152],
                  [-47.65909538475065, -23.41051643696902],
                  [-47.66939506736784, -23.45839704152256],
                  [-47.657722093735025, -23.477607405093515],
                  [-47.615493395004556, -23.476977601450216],
                  [-47.604507066879556, -23.458082094235717],
                  [-47.57498131004362, -23.456822297575833],
                  [-47.56742820945768, -23.440758836742322]]]),
            {
              "reference": 3,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.12163640019317, -27.497321431736268],
                  [-52.93898869511504, -27.43517807290188],
                  [-52.93761540409942, -27.426036389578268],
                  [-52.969887742966606, -27.408969888886823],
                  [-52.975380907029106, -27.394339361262386],
                  [-52.93624211308379, -27.38397489928955],
                  [-52.93349553105254, -27.351046049248882],
                  [-52.895730028122856, -27.316887269481285],
                  [-52.97675419804473, -27.307125685127303],
                  [-52.99666691777129, -27.322987823538057],
                  [-52.96370793339629, -27.34799658621829],
                  [-53.05434514042754, -27.394339361262386],
                  [-53.077004442185356, -27.38031662198073],
                  [-53.134682664841606, -27.455287110880764]]]),
            {
              "reference": 3,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.59245773138431, -27.46234940043024],
                  [-53.534092863220245, -27.39591895414543],
                  [-53.652195890563995, -27.336768362045564],
                  [-53.712620695251495, -27.35323613406043],
                  [-53.668675382751495, -27.486717514867316]]]),
            {
              "reference": 3,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.712097875836996, -25.58737139315513],
                  [-53.643433325055746, -25.29966991937688],
                  [-53.65304636216512, -25.079712914490027],
                  [-53.863159887555746, -25.159291218134],
                  [-53.901612035993246, -25.43368541360792],
                  [-54.16116403794637, -25.47212534428466],
                  [-54.085633032086996, -25.568790812020204]]]),
            {
              "reference": 3,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.63236309794917, -25.257315824710627],
                  [-52.66669537333979, -25.29767428670023],
                  [-52.724030273242136, -25.25576330814142],
                  [-52.72815014628901, -25.243342461210137],
                  [-52.719567077441354, -25.232783743012302],
                  [-52.746002929492136, -25.222845288143812],
                  [-52.839386718554636, -25.26383617756416],
                  [-52.81810070781245, -25.296122286435043],
                  [-52.751496093554636, -25.317538134887016],
                  [-52.660858886523386, -25.30729624481625],
                  [-52.592194335742136, -25.278428079294308]]]),
            {
              "reference": 3,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.696681325835705, -23.859885207932702],
                  [-52.734103506011486, -23.79456060596699],
                  [-52.84568340103102, -23.85862927587021],
                  [-52.830243186911744, -23.88751582505648],
                  [-52.75847942153883, -23.913878761185504]]]),
            {
              "reference": 3,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.89414978002617, -29.749834666214543],
                  [-56.19053649877617, -28.521556935086167],
                  [-54.93809509252617, -29.978492869664255]]]),
            {
              "reference": 3,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-55.52423253354094, -22.055366590528113],
                  [-55.17267003354094, -21.708744211344136],
                  [-55.50225987729094, -21.627063986542982]]]),
            {
              "reference": 3,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-35.59940896692411, -4.893588809737101],
                  [-35.46757302942411, -5.15624708102564],
                  [-35.18192849817411, -5.200013048140642]]]),
            {
              "reference": 3,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-34.58866677942411, -7.274942092571563],
                  [-34.74247537317411, -6.969698940260499],
                  [-34.74247537317411, -8.167643672562974]]]),
            {
              "reference": 3,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.957174056757964, -30.075606351266863],
                  [-50.023092025507964, -29.942416348735282],
                  [-50.253804916132964, -30.075606351266863]]]),
            {
              "reference": 3,
              "system:index": "17"
            })]);

var vesion_in = '6'
var versao_out = '7';
var descricao = 'estabiliza Natural'
var col = 8.0
var prefixo_in = 'MA_col8_p07b_v'
var prefixo_out = 'MA_col8_p07c_v'
var dirout = 'projects/mapbiomas-workspace/COLECAO8/pos_classificacao-ma/';

var palette = require('users/mapbiomas/modules:Palettes.js').get('classification7');

var col8 =  ee.Image(dirout+prefixo_in+vesion_in)
Map.addLayer(col8, {
    'bands': ['classification_2021'],
    'min': 0,
    'max': 62,
    'palette': palette,
    'format': 'png'
}, 'col8', false);

var anos = ['1985','1986','1987','1988','1989','1990',
            '1991','1992','1993','1994','1995','1996','1997','1998','1999','2000',
            '2001','2002','2003','2004','2005','2006','2007','2008','2009','2010',
            '2011','2012','2013','2014','2015','2016','2017','2018','2019','2020',
            '2021','2022'];

var countNaturais = anos.map(function (ano) {
        var image = col8.select('classification_'+ano).remap(
                  [3, 4, 5, 49, 11,12,32,29,50,13],
                  [3, 4, 3,  3, 11,12,32,29,13,13])
        return image.int8();
    }
);

var moda_natural = ee.ImageCollection.fromImages(countNaturais).mode()
Map.addLayer(moda_natural, {
//    'bands': ['classification_' + yearVis.toString()],
    'min': 0,
    'max': 62,
    'palette': palette,
    'format': 'png'
}, 'moda_natural', false);


var anos = ['1985','1986','1987','1988','1989','1990',
            '1991','1992','1993','1994','1995','1996','1997','1998','1999','2000',
            '2001','2002','2003','2004','2005','2006','2007','2008','2009','2010',
            '2011','2012','2013','2014','2015','2016','2017','2018','2019','2020',
            '2021','2022'];
            
for (var i_ano=0;i_ano<anos.length; i_ano++){
  var ano = anos[i_ano];
  var mask_nat_ano = col8.select('classification_'+ano).remap(
                  [3, 4, 5, 49, 11,12,32,29,50,13],
                  [1, 1, 1,  1,  1, 1, 1, 1, 1, 1])
  var moda_natural_ano = moda_natural.mask(mask_nat_ano)
  var corrige_ano = col8.select('classification_'+ano).blend(moda_natural_ano)
  
  var nova_class_reg3 = corrige_ano.clip(remove_reflo_3)
  nova_class_reg3 = nova_class_reg3.remap([3,4,9,11,12,13,21,22,29,33],[3,4,3,11,12,13,21,22,29,33])
  var nova_class_remap = corrige_ano.blend(nova_class_reg3)

                  
  if (i_ano == 0){ var corrige = nova_class_remap.rename('classification_'+ano) }  
  else {corrige = corrige.addBands(nova_class_remap.rename('classification_'+ano)); }
  
}

print(corrige)

Map.addLayer(corrige, {
    'bands': ['classification_2021'],
    'min': 0,
    'max': 62,
    'palette': palette,
    'format': 'png'
}, 'col7 corrigido', false);

corrige = corrige
.set('territory', 'MATAATLANTICA')
.set('biome', 'MATAATLANTICA')
.set('source', 'arcplan')
.set('version', versao_out)
.set('year', versao_out)
.set('collection_id', col)
.set('description', descricao)

Export.image.toAsset({
    'image': corrige,
    'description': prefixo_out+versao_out,
    'assetId': dirout+prefixo_out+versao_out,
    'pyramidingPolicy': {
        '.default': 'mode'
    },
    'region': limite_MA,
    'scale': 30,
    'maxPixels': 1e13
});
